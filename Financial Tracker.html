<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Finance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Orbitron:wght@700&family=Poppins:wght@600&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #334155;
        }
        
        .main-title { font-family: 'Orbitron', sans-serif; }
        .card-title { font-family: 'Poppins', sans-serif; }
        .summary-value, .list-item span.font-semibold { font-family: 'Roboto Mono', monospace; }

        .neumorphic-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(14px) saturate(180%);
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        .neumorphic-card-inset {
            background: #f1f5f9;
            border-radius: 12px;
            box-shadow: inset 5px 5px 10px #e2e8f0, inset -5px -5px 10px #ffffff;
        }

        .input-field {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            color: #334155;
            border-radius: 10px;
        }
        
        .input-field:focus {
            outline: none;
            box-shadow: 0 0 0 2px #3b82f6;
        }

        .btn {
            background: #f1f5f9;
            border-radius: 10px;
            box-shadow: 4px 4px 8px #d1d9e6, -4px -4px 8px #ffffff;
            color: #475569;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            box-shadow: 2px 2px 4px #d1d9e6, -2px -2px 4px #ffffff;
        }
        .btn:active {
            box-shadow: inset 2px 2px 4px #d1d9e6, inset -2px -2px 4px #ffffff;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .btn-primary { background-image: linear-gradient(to right, #4f46e5, #7c3aed); color: white; }
        .btn-success { background-image: linear-gradient(to right, #16a34a, #65a30d); color: white; }
        
        .btn-danger {
            background-image: linear-gradient(to right, #dc2626, #be123c);
            color: white;
        }

        .list-item {
            background: #f1f5f9;
            border-radius: 10px;
            animation: fadeIn 0.5s ease;
            margin-bottom: 8px;
            padding: 12px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .profit { color: #16a34a; }
        .loss { color: #dc2626; }
        
        @keyframes value-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }

        .pop-animation {
            animation: value-pop 0.4s ease-in-out;
        }

        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(-45deg, #e0e7ff, #ffffff, #e0f2fe, #f3e8ff);
            background-size: 400% 400%;
            animation: gradient-animation 15s ease infinite;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
            overflow: hidden;
        }
        
        .floating-symbol {
            position: absolute;
            font-size: 5rem;
            color: rgba(0, 0, 0, 0.08);
            animation: float 20s infinite linear;
            user-select: none;
        }
        @keyframes float {
            0% { transform: translateY(100vh) rotate(0deg); }
            100% { transform: translateY(-100vh) rotate(360deg); }
        }

        .lock { transition: all 0.5s ease; }
        .lock .shackle {
            transition: transform 0.4s ease-in-out;
            transform-origin: 25% 100%;
        }
        .lock.unlocked .shackle {
            transform: translateY(-25px) rotate(15deg);
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .item-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .remove-btn {
            background: #ef4444;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .remove-btn:hover {
            background: #dc2626;
        }

        #dashboard-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            background-color: #f8fafc;
        }

        .graffiti-symbol {
            position: absolute;
            font-family: 'Orbitron', sans-serif;
            user-select: none;
            animation: graffiti-float 25s infinite linear;
        }

        @keyframes graffiti-float {
            0% { transform: translate(0, 0) rotate(0deg); opacity: 0; }
            25% { opacity: 1; }
            50% { transform: translate(var(--tx1), var(--ty1)) rotate(180deg); }
            75% { opacity: 1; }
            100% { transform: translate(var(--tx2), var(--ty2)) rotate(360deg); opacity: 0; }
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div id="dashboard-background"></div>

    <div id="login-overlay">
        <div id="login-bg"></div>
        <div class="neumorphic-card p-8 w-full max-w-sm text-center z-10">
            <div id="lock-container" class="mb-6">
                <svg class="lock w-20 h-20 mx-auto" viewBox="0 0 100 100">
                    <path class="shackle" d="M 50 40 A 20 20 0 0 1 50 0 A 20 20 0 0 1 50 40 L 50 20 A 20 20 0 0 0 50 20 M 25 40 L 25 20 A 25 25 0 0 1 75 20 L 75 40" fill="#94a3b8"/>
                    <rect class="body" x="15" y="40" width="70" height="50" rx="10" fill="#e2e8f0"/>
                </svg>
            </div>
            <h2 id="login-title" class="main-title text-2xl font-bold text-slate-800 mb-6">Login</h2>
            <form id="login-form" class="space-y-4">
                <input type="text" id="username" placeholder="Username" class="input-field w-full p-3" required>
                <input type="password" id="password" placeholder="Password" class="input-field w-full p-3">
                <input type="password" id="confirm-password" placeholder="Confirm Password" class="input-field w-full p-3 hidden">
                <p id="login-error" class="text-red-500 text-sm h-4"></p>
                <button type="submit" id="login-button" class="btn btn-primary w-full py-3">Login</button>
                <a href="#" id="forgot-password" class="text-xs text-slate-500 hover:text-slate-800">Forgot Password?</a>
            </form>
        </div>
    </div>

    <div id="dashboard-content" class="max-w-screen-2xl mx-auto opacity-0 transition-opacity duration-500">
        <header class="text-center mb-10">
            <h1 class="main-title text-3xl sm:text-4xl font-bold text-slate-800 tracking-wider uppercase">Monthly Finance Dashboard</h1>
            <p class="text-slate-500 mt-2">Your personal finance tracker with persistent storage.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <div class="lg:col-span-2 space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="neumorphic-card p-6">
                        <h2 class="card-title text-xl font-semibold mb-4 text-slate-800">Month</h2>
                        <label for="month-selector" class="block text-sm font-medium text-slate-500 mb-1">Select Month</label>
                        <input type="month" id="month-selector" class="input-field w-full p-3">
                    </div>
                    <div class="neumorphic-card p-6">
                        <h2 class="card-title text-xl font-semibold mb-4 text-slate-800">Income</h2>
                        <label for="income" class="block text-sm font-medium text-slate-500 mb-1">Monthly Income (‚Çπ)</label>
                        <input type="number" id="income" placeholder="e.g., 50000" class="input-field w-full rounded-md p-3">
                    </div>
                </div>

                <!-- NEW: Goals & Planning Section -->
                <div class="neumorphic-card p-6">
                    <h2 class="card-title text-xl font-semibold mb-4 text-slate-800">Goals & Planning</h2>
                    <label for="monthly-goals" class="block text-sm font-medium text-slate-500 mb-1">What are your financial goals for this month?</label>
                    <textarea id="monthly-goals" rows="4" placeholder="e.g.,&#10;- Save ‚Çπ15,000 for vacation&#10;- Reduce dining out by 20%&#10;- Pay off ‚Çπ5,000 on credit card" class="input-field w-full rounded-md p-3"></textarea>
                </div>

                <div class="neumorphic-card p-6">
                    <h2 class="card-title text-xl font-semibold mb-4 text-slate-800">Emergency Funds</h2>
                    <label for="emergency-funds" class="block text-sm font-medium text-slate-500 mb-1">This Month's Contribution (‚Çπ)</label>
                    <input type="number" id="emergency-funds" placeholder="e.g., 5000" class="input-field w-full rounded-md p-3">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8" id="dynamic-lists"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8" id="lend-borrow-cards"></div>
            </div>

            <div class="lg:col-span-3 space-y-8">
                <div class="neumorphic-card p-6">
                    <h2 class="card-title text-2xl font-semibold mb-6 text-slate-800">Financial Summary</h2>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                        <div class="p-4 rounded-xl neumorphic-card-inset"><h3 class="text-sm font-medium text-green-600">Total Income</h3><p id="summary-income" class="summary-value text-2xl font-bold text-green-600 mt-1">‚Çπ0</p></div>
                        <div class="p-4 rounded-xl neumorphic-card-inset"><h3 class="text-sm font-medium text-red-600">Total Outflow</h3><p id="summary-outflow" class="summary-value text-2xl font-bold text-red-600 mt-1">‚Çπ0</p></div>
                        <div class="p-4 rounded-xl neumorphic-card-inset"><h3 class="text-sm font-medium text-slate-600">Profit / Loss</h3><p id="summary-profit" class="summary-value text-2xl font-bold mt-1">‚Çπ0</p></div>
                        <div class="p-4 rounded-xl neumorphic-card-inset"><h3 class="text-sm font-medium text-cyan-600">Total Emergency Funds</h3><p id="summary-emergency" class="summary-value text-2xl font-bold text-cyan-600 mt-1">‚Çπ0</p></div>
                        <div class="p-4 rounded-xl neumorphic-card-inset col-span-2"><h3 class="text-sm font-medium text-blue-600">Remaining Balance</h3><p id="summary-balance" class="summary-value text-3xl font-bold text-blue-600 mt-1">‚Çπ0</p></div>
                        <div class="p-4 rounded-xl neumorphic-card-inset"><h3 class="text-sm font-medium text-orange-600">Money Lent</h3><p id="summary-lent" class="summary-value text-2xl font-bold text-orange-600 mt-1">‚Çπ0</p></div>
                        <div class="p-4 rounded-xl neumorphic-card-inset"><h3 class="text-sm font-medium text-purple-600">Money Borrowed</h3><p id="summary-borrowed" class="summary-value text-2xl font-bold text-purple-600 mt-1">‚Çπ0</p></div>
                    </div>
                </div>
                
                <div class="neumorphic-card p-6" id="lend-borrow-tables-container"></div>

                <div class="neumorphic-card p-6">
                     <h2 class="card-title text-2xl font-semibold mb-6 text-slate-800">Current Month Breakdown</h2>
                     <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                         <div><h3 class="card-title text-lg font-semibold text-center mb-4">Outflow Categories</h3><div class="relative h-64 sm:h-80 w-full mx-auto"><canvas id="expenseChart"></canvas></div></div>
                         <div><h3 class="card-title text-lg font-semibold text-center mb-4">Income vs. Outflow</h3><div class="relative h-64 sm:h-80 w-full"><canvas id="flowChart"></canvas></div></div>
                     </div>
                </div>
                
                <div class="neumorphic-card p-6">
                    <h2 class="card-title text-2xl font-semibold mb-6 text-slate-800">Historical Trends</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div><h3 class="card-title font-semibold text-center mb-2">Expenses</h3><canvas id="expenses-trend-chart"></canvas></div>
                        <div><h3 class="card-title font-semibold text-center mb-2">Debts</h3><canvas id="debts-trend-chart"></canvas></div>
                        <div><h3 class="card-title font-semibold text-center mb-2">Investments</h3><canvas id="investments-trend-chart"></canvas></div>
                        <div><h3 class="card-title font-semibold text-center mb-2">Bills</h3><canvas id="bills-trend-chart"></canvas></div>
                    </div>
                </div>

                <div class="neumorphic-card p-6">
                    <h2 class="card-title text-2xl font-semibold mb-6 text-slate-800">Forecasting & Suggestions</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 items-end">
                        <div>
                            <label for="forecast-category" class="block text-sm font-medium text-slate-500 mb-1">Forecast Category</label>
                            <select id="forecast-category" class="input-field w-full p-2.5">
                                <option value="totalOutflow">Total Outflow</option>
                                <option value="savings">Savings (Profit/Loss)</option>
                                <option value="income">Income</option>
                                <option value="expenses">Expenses</option>
                            </select>
                        </div>
                        <div>
                            <label for="forecast-months" class="block text-sm font-medium text-slate-500 mb-1">Future Months</label>
                            <input type="number" id="forecast-months" value="3" min="1" max="12" class="input-field w-full p-2">
                        </div>
                        <button id="generate-forecast-btn" class="btn btn-primary w-full py-2.5">Generate Forecast</button>
                    </div>
                    <div class="mb-6 h-80"><canvas id="forecast-chart"></canvas></div>
                    <div>
                        <h3 class="card-title font-semibold text-center mb-4">Financial Analysis</h3>
                        <div id="financial-analysis-text" class="p-4 rounded-xl neumorphic-card-inset text-sm space-y-2">
                            <p>Generate a forecast to see your financial analysis and suggestions.</p>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-8"><button id="download-btn" class="btn btn-primary py-3 px-8 rounded-lg">Download Report</button></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const STORAGE_KEY_DATA = 'financeTrackerData';
            const STORAGE_KEY_AUTH = 'financeTrackerAuth';
            
            const loginOverlay = document.getElementById('login-overlay');
            const loginForm = document.getElementById('login-form');
            const loginTitle = document.getElementById('login-title');
            const loginButton = document.getElementById('login-button');
            const confirmPasswordField = document.getElementById('confirm-password');
            const loginError = document.getElementById('login-error');
            const dashboardContent = document.getElementById('dashboard-content');
            const lock = document.querySelector('.lock');
            const forgotPasswordLink = document.getElementById('forgot-password');
            const loginBg = document.getElementById('login-bg');

            let authData = JSON.parse(localStorage.getItem(STORAGE_KEY_AUTH) || 'null');
            let isSetupMode = !authData;
            let isForgotPasswordMode = false;
            
            const listConfigs = [
                { type: 'expenses', title: 'Expenses' },
                { type: 'debts', title: 'Debts', isDebt: true },
                { type: 'investments', title: 'Investments' },
                { type: 'bills', title: 'Bills' }
            ];
            
            const lendBorrowConfigs = [
                { type: 'lent', title: 'Money Lent', person: 'Borrower', dateLabel: 'Return Date' },
                { type: 'borrowed', title: 'Money Borrowed', person: 'Lender', dateLabel: 'Payment Date' }
            ];

            const createFloatingSymbols = () => {
                const symbols = ['‚Çπ', '$', '‚Ç¨', '¬•', 'üìà', 'üìâ'];
                for (let i = 0; i < 15; i++) {
                    const symbol = document.createElement('div');
                    symbol.className = 'floating-symbol';
                    symbol.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                    symbol.style.left = `${Math.random() * 100}vw`;
                    symbol.style.animationDuration = `${Math.random() * 10 + 10}s`;
                    symbol.style.animationDelay = `${Math.random() * 5}s`;
                    loginBg.appendChild(symbol);
                }
            };

            const createDashboardGraffiti = () => {
                const background = document.getElementById('dashboard-background');
                const symbols = ['‚Çπ', 'ÔºÑ', '‚Ç¨', '¬•', '‚Çø', 'ÔøΩ', 'üìâ', 'üìä', 'üè¶', '¬©', '‚Ñ¢'];
                const colors = ['#3b82f6', '#16a34a', '#ef4444', '#f97316', '#8b5cf6', '#475569'];
                
                for (let i = 0; i < 25; i++) {
                    const symbol = document.createElement('div');
                    symbol.className = 'graffiti-symbol';
                    symbol.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                    symbol.style.top = `${Math.random() * 100}%`;
                    symbol.style.left = `${Math.random() * 100}%`;
                    symbol.style.fontSize = `${Math.random() * 4 + 2}rem`;
                    symbol.style.color = colors[Math.floor(Math.random() * colors.length)] + '20';
                    symbol.style.transform = `rotate(${Math.random() * 360}deg)`;
                    
                    symbol.style.setProperty('--tx1', `${Math.random() * 100 - 50}px`);
                    symbol.style.setProperty('--ty1', `${Math.random() * 100 - 50}px`);
                    symbol.style.setProperty('--tx2', `${Math.random() * 100 - 50}px`);
                    symbol.style.setProperty('--ty2', `${Math.random() * 100 - 50}px`);
                    symbol.style.animationDuration = `${Math.random() * 20 + 15}s`;
                    symbol.style.animationDelay = `${Math.random() * 10}s`;

                    background.appendChild(symbol);
                }
            };

            const setupLoginScreen = () => {
                if (isSetupMode) {
                    loginTitle.textContent = 'Create Account';
                    loginButton.textContent = 'Create';
                    confirmPasswordField.classList.remove('hidden');
                    forgotPasswordLink.classList.add('hidden');
                } else if (isForgotPasswordMode) {
                    loginTitle.textContent = 'Forgot Password';
                    loginButton.textContent = 'Show Password';
                    document.getElementById('password').classList.add('hidden');
                    confirmPasswordField.classList.add('hidden');
                } else {
                    loginTitle.textContent = 'Login';
                    loginButton.textContent = 'Login';
                    document.getElementById('password').classList.remove('hidden');
                    confirmPasswordField.classList.add('hidden');
                    forgotPasswordLink.classList.remove('hidden');
                }
            };

            forgotPasswordLink.addEventListener('click', (e) => {
                e.preventDefault();
                isForgotPasswordMode = true;
                setupLoginScreen();
            });

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                loginError.textContent = '';

                if (isSetupMode) {
                    const confirmPassword = confirmPasswordField.value;
                    if (password !== confirmPassword) {
                        loginError.textContent = 'Passwords do not match.';
                        return;
                    }
                    localStorage.setItem(STORAGE_KEY_AUTH, JSON.stringify({ username, password }));
                    isSetupMode = false;
                    authData = { username, password };
                    unlockDashboard();
                } else if (isForgotPasswordMode) {
                     if (username === authData.username) {
                        alert(`Your password is: ${authData.password}`);
                        isForgotPasswordMode = false;
                        setupLoginScreen();
                    } else {
                        loginError.textContent = 'Username not found.';
                    }
                } else {
                    if (username === authData.username && password === authData.password) {
                        unlockDashboard();
                    } else {
                        loginError.textContent = 'Invalid username or password.';
                    }
                }
            });

            const unlockDashboard = () => {
                lock.classList.add('unlocked');
                createDashboardGraffiti();
                setTimeout(() => {
                    loginOverlay.style.opacity = '0';
                    setTimeout(() => {
                        loginOverlay.style.display = 'none';
                        dashboardContent.style.opacity = '1';
                        init();
                    }, 500);
                }, 600);
            };
            
            const init = () => {
                let state = { monthlyData: [], currentMonthIndex: 0 };
                let chartInstances = {};
                
                const getInitialData = () => {
                    const savedData = localStorage.getItem(STORAGE_KEY_DATA);
                    if (savedData) return JSON.parse(savedData);
                    
                    const today = new Date();
                    const month = today.toISOString().slice(0, 7) + '-01';
                    return [{
                        month: month,
                        income: 0,
                        emergency_funds: 0,
                        goals: '', // NEW: Initialize goals
                        items: { expenses: [], debts: [], investments: [], bills: [], lent: [], borrowed: [] }
                    }];
                };
                
                state.monthlyData = getInitialData();
                state.currentMonthIndex = state.monthlyData.length - 1;

                const incomeInput = document.getElementById('income');
                const emergencyFundsInput = document.getElementById('emergency-funds');
                const monthlyGoalsInput = document.getElementById('monthly-goals'); // NEW
                const dynamicListsContainer = document.getElementById('dynamic-lists');
                const lendBorrowCardsContainer = document.getElementById('lend-borrow-cards');
                const lendBorrowTablesContainer = document.getElementById('lend-borrow-tables-container');
                const summaryIncome = document.getElementById('summary-income');
                const summaryOutflow = document.getElementById('summary-outflow');
                const summaryProfit = document.getElementById('summary-profit');
                const summaryBalance = document.getElementById('summary-balance');
                const summaryEmergency = document.getElementById('summary-emergency');
                const summaryLent = document.getElementById('summary-lent');
                const summaryBorrowed = document.getElementById('summary-borrowed');
                const downloadBtn = document.getElementById('download-btn');
                const monthSelector = document.getElementById('month-selector');
                const generateForecastBtn = document.getElementById('generate-forecast-btn');

                const saveData = () => {
                    localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(state.monthlyData));
                };
                
                const formatCurrency = (amount) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);

                const animateCountUp = (element, endValue) => {
                    element.classList.add('pop-animation');
                    element.addEventListener('animationend', () => element.classList.remove('pop-animation'), { once: true });

                    let startValue = parseFloat(element.textContent.replace(/[^0-9.-]+/g,"")) || 0;
                    if (isNaN(startValue)) startValue = 0;
                    const duration = 300;
                    let startTime = null;
                    const step = (timestamp) => {
                        if (!startTime) startTime = timestamp;
                        const progress = Math.min((timestamp - startTime) / duration, 1);
                        const currentValue = Math.floor(progress * (endValue - startValue) + startValue);
                        element.textContent = formatCurrency(currentValue);
                        if (progress < 1) window.requestAnimationFrame(step);
                        else element.textContent = formatCurrency(endValue);
                    };
                    window.requestAnimationFrame(step);
                };
                
                const createDynamicListCard = ({ type, title, person, isDebt, dateLabel }) => {
                    const card = document.createElement('div');
                    card.className = 'neumorphic-card p-6';
                    
                    let inputsHTML = '';
                    if (isDebt) {
                        inputsHTML = `
                            <input type="text" id="${type}-name" placeholder="Debt Name" class="input-field rounded-md p-2 text-sm">
                            <input type="number" id="${type}-totalAmount" placeholder="Total Amount (‚Çπ)" class="input-field rounded-md p-2 text-sm">
                            <input type="number" id="${type}-amount" placeholder="Monthly Payment (‚Çπ)" class="input-field rounded-md p-2 text-sm">
                            <input type="date" id="${type}-date" class="input-field rounded-md p-2 text-sm">`;
                    } else {
                        const placeholder = person ? `${person}'s Name` : 'Name';
                        const dateFieldLabel = dateLabel || 'Date';
                        inputsHTML = `
                            <input type="text" id="${type}-name" placeholder="${placeholder}" class="input-field rounded-md p-2 text-sm">
                            <input type="number" id="${type}-amount" placeholder="Amount (‚Çπ)" class="input-field rounded-md p-2 text-sm">
                            <label for="${type}-date" class="text-xs text-slate-400 px-1">${dateFieldLabel}</label>
                            <input type="date" id="${type}-date" class="input-field rounded-md p-2 text-sm">
                            ${person ? '' : `<input type="text" id="${type}-description" placeholder="Description" class="input-field rounded-md p-2 text-sm">`}`;
                    }

                    card.innerHTML = `
                        <h2 class="card-title text-xl font-semibold mb-4 text-slate-800">${title}</h2>
                        <div class="grid grid-cols-1 gap-2 mb-4">${inputsHTML}</div>
                        <button id="add-${type}" class="btn btn-primary w-full py-2 px-4">Add ${title.slice(0, -1)}</button>
                        <div id="${type}-list" class="item-list mt-4"></div>`;
                    
                    if (person) lendBorrowCardsContainer.appendChild(card);
                    else dynamicListsContainer.appendChild(card);
                };
                
                const renderItemList = (type) => {
                    const listContainer = document.getElementById(`${type}-list`);
                    if (!listContainer) return;
                    
                    const currentMonthData = state.monthlyData[state.currentMonthIndex];
                    const items = currentMonthData.items[type] || [];
                    
                    listContainer.innerHTML = '';
                    
                    items.forEach((item, index) => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'list-item flex justify-between items-center';
                        
                        const dateStr = new Date(item.date).toLocaleDateString('en-GB');
                        let displayText = `${item.name} - ${formatCurrency(item.amount)} (${dateStr})`;
                        
                        if (item.totalAmount) displayText += ` [Total: ${formatCurrency(item.totalAmount)}]`;
                        if (item.description) displayText += ` - ${item.description}`;
                        
                        itemDiv.innerHTML = `<span class="font-medium text-sm">${displayText}</span><button class="remove-btn" data-type="${type}" data-index="${index}">√ó</button>`;
                        listContainer.appendChild(itemDiv);
                    });
                };
                
                const updateDashboard = () => {
                    if (state.monthlyData.length === 0) return;
                    const currentMonthData = state.monthlyData[state.currentMonthIndex];
                    
                    updateMonthSelector();
                    incomeInput.value = currentMonthData.income || 0;
                    emergencyFundsInput.value = currentMonthData.emergency_funds || 0;
                    monthlyGoalsInput.value = currentMonthData.goals || ''; // NEW

                    const monthDate = new Date(currentMonthData.month);
                    const firstDay = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1).toISOString().split('T')[0];
                    const lastDay = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0).toISOString().split('T')[0];
                    
                    [...listConfigs, ...lendBorrowConfigs].forEach(({ type }) => {
                        const dateInput = document.getElementById(`${type}-date`);
                        if (dateInput) {
                            dateInput.value = firstDay;
                            if (type !== 'lent' && type !== 'borrowed') {
                                 dateInput.min = firstDay;
                                 dateInput.max = lastDay;
                            }
                        }
                        renderItemList(type);
                    });

                    const emergencyFundContribution = currentMonthData.emergency_funds || 0;
                    const itemOutflow = ['expenses', 'debts', 'investments', 'bills'].reduce((sum, type) => sum + (currentMonthData.items[type] || []).reduce((s, i) => s + (i.amount || 0), 0), 0);
                    const totalOutflow = itemOutflow + emergencyFundContribution;
                    const profit = (currentMonthData.income || 0) - totalOutflow;
                    const totalEmergency = state.monthlyData.slice(0, state.currentMonthIndex + 1).reduce((sum, month) => sum + (month.emergency_funds || 0), 0);
                    const totalLent = (currentMonthData.items.lent || []).reduce((s, i) => s + (i.amount || 0), 0);
                    const totalBorrowed = (currentMonthData.items.borrowed || []).reduce((s, i) => s + (i.amount || 0), 0);
                    
                    animateCountUp(summaryIncome, currentMonthData.income || 0);
                    animateCountUp(summaryOutflow, totalOutflow);
                    animateCountUp(summaryProfit, profit);
                    animateCountUp(summaryBalance, profit);
                    animateCountUp(summaryEmergency, totalEmergency);
                    animateCountUp(summaryLent, totalLent);
                    animateCountUp(summaryBorrowed, totalBorrowed);

                    summaryProfit.className = `summary-value text-2xl font-bold mt-1 ${profit >= 0 ? 'profit' : 'loss'}`;
                    
                    updateLendBorrowTables(currentMonthData);
                    updateMonthCharts(currentMonthData, totalOutflow);
                    updateHistoricalCharts();
                    saveData();
                };
                
                const updateMonthSelector = () => {
                    const currentMonth = state.monthlyData[state.currentMonthIndex].month;
                    monthSelector.value = currentMonth.slice(0, 7);
                };
                
                const createOrUpdateChart = (id, options) => {
                    const canvas = document.getElementById(id);
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    if (chartInstances[id]) chartInstances[id].destroy();
                    chartInstances[id] = new Chart(ctx, options);
                };

                const updateMonthCharts = (currentMonthData, totalOutflow) => {
                    const vibrantColors = ['#ef4444', '#f97316', '#8b5cf6', '#3b82f6'];
                    const categoryTotals = listConfigs.map(({ type, title }) => ({
                        label: title,
                        amount: (currentMonthData.items[type] || []).reduce((sum, item) => sum + (item.amount || 0), 0)
                    })).filter(cat => cat.amount > 0);

                    if (categoryTotals.length > 0) {
                        createOrUpdateChart('expenseChart', {
                            type: 'doughnut',
                            data: {
                                labels: categoryTotals.map(c => c.label),
                                datasets: [{ data: categoryTotals.map(c => c.amount), backgroundColor: vibrantColors, borderColor: 'rgba(255, 255, 255, 0.7)', borderWidth: 5 }]
                            },
                            options: { responsive: true, maintainAspectRatio: false, animation: { animateScale: true, duration: 1000 }, plugins: { legend: { position: 'bottom', labels: { color: '#475569', font: { size: 12 }, padding: 20 } }, datalabels: { color: '#334155', font: { family: 'Poppins' }, formatter: (value, ctx) => (ctx.chart.getDatasetMeta(0).total > 0 ? (value / ctx.chart.getDatasetMeta(0).total * 100).toFixed(1) + '%' : '') } } }
                        });
                    }

                    createOrUpdateChart('flowChart', {
                        type: 'bar',
                        data: {
                            labels: ['Financial Flow'],
                            datasets: [
                                { label: 'Income', data: [currentMonthData.income || 0], backgroundColor: '#16a34a', borderRadius: 5 },
                                { label: 'Outflow', data: [totalOutflow], backgroundColor: '#ef4444', borderRadius: 5 }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, animation: { duration: 1000, easing: 'easeOutBounce' }, scales: { y: { beginAtZero: true, ticks: { color: '#64748b' }, grid: { color: '#e2e8f0' } }, x: { ticks: { color: '#64748b' }, grid: { display: false } } }, plugins: { legend: { labels: { color: '#475569' } } } }
                    });
                };
                
                const handleAddItem = (type) => {
                    const nameInput = document.getElementById(`${type}-name`);
                    const amountInput = document.getElementById(`${type}-amount`);
                    const dateInput = document.getElementById(`${type}-date`);
                    const descriptionInput = document.getElementById(`${type}-description`);
                    const totalAmountInput = document.getElementById(`${type}-totalAmount`);
                    
                    if (!nameInput || !amountInput || !dateInput) return;
                    
                    const name = nameInput.value.trim();
                    const amount = parseFloat(amountInput.value);
                    const totalAmount = totalAmountInput ? parseFloat(totalAmountInput.value) : null;
                    const date = dateInput.value;
                    const description = descriptionInput ? descriptionInput.value.trim() : '';

                    if (name && !isNaN(amount) && amount > 0 && date) {
                        const newItem = { name, amount, date };
                        if (description) newItem.description = description;
                        if (totalAmount !== null && !isNaN(totalAmount) && totalAmount > 0) newItem.totalAmount = totalAmount;
                        if (!state.monthlyData[state.currentMonthIndex].items[type]) state.monthlyData[state.currentMonthIndex].items[type] = [];
                        state.monthlyData[state.currentMonthIndex].items[type].push(newItem);
                        
                        nameInput.value = '';
                        amountInput.value = '';
                        if (descriptionInput) descriptionInput.value = '';
                        if (totalAmountInput) totalAmountInput.value = '';
                        
                        nameInput.focus();
                        updateDashboard();
                    } else {
                        alert('Please fill in all required fields with valid values.');
                    }
                };

                const handleRemoveItem = (e) => {
                    if (e.target.classList.contains('remove-btn')) {
                        const { type, index } = e.target.dataset;
                        const itemIndex = parseInt(index);
                        if (state.monthlyData[state.currentMonthIndex].items[type] && itemIndex >= 0 && itemIndex < state.monthlyData[state.currentMonthIndex].items[type].length) {
                            state.monthlyData[state.currentMonthIndex].items[type].splice(itemIndex, 1);
                            updateDashboard();
                        }
                    }
                };
                
                // --- NEW: Professional PDF Download Function ---
                const handleDownload = async () => {
                    downloadBtn.disabled = true;
                    downloadBtn.textContent = 'Generating...';

                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                    const currentData = state.monthlyData[state.currentMonthIndex];
                    const monthName = new Date(currentData.month).toLocaleString('default', { month: 'long', year: 'numeric' });
                    const A4_WIDTH = 210;
                    const A4_HEIGHT = 297;
                    const MARGIN = 15;
                    let yPos = 0;

                    // --- PDF Styling & Helpers ---
                    const PRIMARY_COLOR = '#2c3e50';
                    const SECONDARY_COLOR = '#3498db';
                    const TEXT_COLOR = '#34495e';
                    const LIGHT_TEXT_COLOR = '#7f8c8d';
                    
                    const addHeader = () => {
                        pdf.setFont('helvetica', 'bold');
                        pdf.setFontSize(20);
                        pdf.setTextColor(PRIMARY_COLOR);
                        pdf.text('Financial Insights Report', MARGIN, 20);
                        
                        pdf.setFontSize(12);
                        pdf.setTextColor(LIGHT_TEXT_COLOR);
                        pdf.text(monthName, A4_WIDTH - MARGIN, 20, { align: 'right' });
                        
                        pdf.setDrawColor(SECONDARY_COLOR);
                        pdf.setLineWidth(0.5);
                        pdf.line(MARGIN, 25, A4_WIDTH - MARGIN, 25);
                        yPos = 35;
                    };

                    const addFooter = () => {
                        const pageCount = pdf.internal.getNumberOfPages();
                        for (let i = 1; i <= pageCount; i++) {
                            pdf.setPage(i);
                            pdf.setFontSize(8);
                            pdf.setTextColor(LIGHT_TEXT_COLOR);
                            pdf.text(`Page ${i} of ${pageCount}`, A4_WIDTH / 2, A4_HEIGHT - 10, { align: 'center' });
                            pdf.text('Confidential | Generated by Finance Tracker Pro', MARGIN, A4_HEIGHT - 10);
                        }
                    };

                    const addSectionTitle = (title) => {
                        if (yPos > A4_HEIGHT - 40) {
                            pdf.addPage();
                            addHeader();
                        }
                        pdf.setFont('helvetica', 'bold');
                        pdf.setFontSize(14);
                        pdf.setTextColor(SECONDARY_COLOR);
                        pdf.text(title, MARGIN, yPos);
                        yPos += 8;
                    };
                    
                    const addChartToPdf = async (canvasId, width, height) => {
                        const canvas = document.getElementById(canvasId);
                        if (canvas) {
                            const imgData = await html2canvas(canvas, { backgroundColor: '#ffffff' }).then(c => c.toDataURL('image/png'));
                            if (yPos + height > A4_HEIGHT - 20) {
                                pdf.addPage();
                                addHeader();
                            }
                            pdf.addImage(imgData, 'PNG', MARGIN, yPos, width, height);
                            yPos += height + 10;
                        }
                    };

                    // --- Build PDF Content ---
                    addHeader();

                    // --- Executive Summary ---
                    addSectionTitle('Executive Summary');
                    const income = currentData.income || 0;
                    const itemOutflow = ['expenses', 'debts', 'investments', 'bills'].reduce((sum, type) => sum + (currentData.items[type] || []).reduce((s, i) => s + (i.amount || 0), 0), 0);
                    const totalOutflow = itemOutflow + (currentData.emergency_funds || 0);
                    const profit = income - totalOutflow;
                    const savingsRate = income > 0 ? (profit / income * 100).toFixed(1) : 0;

                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(10);
                    pdf.setTextColor(TEXT_COLOR);
                    pdf.text(`This report provides a detailed analysis of your financial activity for ${monthName}. You generated an income of ${formatCurrency(income)} and had a total outflow of ${formatCurrency(totalOutflow)}, resulting in a net ${profit >= 0 ? 'profit' : 'loss'} of ${formatCurrency(profit)}. Your savings rate for the month was ${savingsRate}%.`, MARGIN, yPos, { maxWidth: A4_WIDTH - MARGIN * 2 });
                    yPos += 20;

                    // --- Goals ---
                    if (currentData.goals) {
                        addSectionTitle("This Month's Goals");
                        pdf.setFont('helvetica', 'normal');
                        pdf.text(currentData.goals, MARGIN, yPos, { maxWidth: A4_WIDTH - MARGIN * 2 });
                        yPos += 20;
                    }
                    
                    // --- Key Metrics & Visuals ---
                    addSectionTitle('Monthly Financial Overview');
                    await addChartToPdf('flowChart', 85, 60);
                    await addChartToPdf('expenseChart', 85, 60);

                    // --- Detailed Tables ---
                    const addTableToPdf = (type, title) => {
                        const items = currentData.items[type] || [];
                        if (items.length === 0) return;

                        const head = type === 'debts' ? [['Name', 'Monthly Payment', 'Total Debt', 'Date']] : [['Name', 'Amount', 'Description', 'Date']];
                        const body = items.map(item => {
                            if (type === 'debts') return [item.name, formatCurrency(item.amount), formatCurrency(item.totalAmount || 0), new Date(item.date).toLocaleDateString('en-GB')];
                            return [item.name, formatCurrency(item.amount), item.description || '-', new Date(item.date).toLocaleDateString('en-GB')];
                        });
                        
                        if (yPos > A4_HEIGHT - 60) {
                           pdf.addPage();
                           addHeader();
                        }
                        addSectionTitle(title);

                        pdf.autoTable({
                            head: head,
                            body: body,
                            startY: yPos,
                            theme: 'grid',
                            headStyles: { fillColor: SECONDARY_COLOR, textColor: '#ffffff' },
                            styles: { font: 'helvetica', fontSize: 9 }
                        });
                        yPos = pdf.autoTable.previous.finalY + 10;
                    };
                    
                    pdf.addPage();
                    addHeader();
                    listConfigs.forEach(config => addTableToPdf(config.type, `Detailed ${config.title}`));
                    lendBorrowConfigs.forEach(config => addTableToPdf(config.type, config.title));

                    // --- Analysis & Forecast ---
                    pdf.addPage();
                    addHeader();
                    addSectionTitle('Forecast & Financial Health Analysis');
                    await addChartToPdf('forecast-chart', 180, 80);
                    
                    const analysisText = document.getElementById('financial-analysis-text').innerText;
                    pdf.setFont('helvetica', 'normal');
                    const splitText = pdf.splitTextToSize(analysisText.replace(/‚úÖ|‚ö†Ô∏è|‚ùå|üìà/g, ''), 180);
                    pdf.text(splitText, MARGIN, yPos);

                    // --- Finalize and Save ---
                    addFooter();
                    pdf.save(`Financial_Report_${currentData.month.slice(0,7)}.pdf`);
                    downloadBtn.disabled = false;
                    downloadBtn.textContent = 'Download Report';
                };

                const updateLendBorrowTables = (currentData) => {
                    lendBorrowTablesContainer.innerHTML = '';
                    
                    const createTable = (type, title, headers) => {
                        const items = currentData.items[type] || [];
                        if (items.length === 0) return;

                        const tableWrapper = document.createElement('div');
                        let tableHTML = `<h3 class="card-title text-lg font-semibold text-center mb-4">${title}</h3>
                                         <div class="overflow-x-auto"><table class="w-full text-sm text-left">
                                         <thead class="text-xs text-slate-700 uppercase bg-slate-200">
                                         <tr>`;
                        headers.forEach(h => tableHTML += `<th scope="col" class="px-4 py-2">${h}</th>`);
                        tableHTML += `</tr></thead><tbody>`;

                        items.forEach(item => {
                            tableHTML += `<tr class="bg-white border-b border-slate-200">
                                <td class="px-4 py-2 font-medium text-slate-900">${item.name}</td>
                                <td class="px-4 py-2 table-value">${formatCurrency(item.amount)}</td>
                                <td class="px-4 py-2">${new Date(item.date).toLocaleDateString('en-GB')}</td>
                            </tr>`;
                        });

                        tableHTML += `</tbody></table></div>`;
                        tableWrapper.innerHTML = tableHTML;
                        lendBorrowTablesContainer.appendChild(tableWrapper);
                    };

                    createTable('lent', 'Money Lent Details', ['Borrower', 'Amount', 'Return Date']);
                    createTable('borrowed', 'Money Borrowed Details', ['Lender', 'Amount', 'Payment Date']);
                };

                const updateHistoricalCharts = () => {
                    const trendConfigs = [
                        { type: 'expenses', chartId: 'expenses-trend-chart', color: '#ef4444' },
                        { type: 'debts', chartId: 'debts-trend-chart', color: '#f97316' },
                        { type: 'investments', chartId: 'investments-trend-chart', color: '#8b5cf6' },
                        { type: 'bills', chartId: 'bills-trend-chart', color: '#3b82f6' }
                    ];

                    trendConfigs.forEach(config => {
                        const labels = state.monthlyData.map(d => new Date(d.month).toLocaleString('default', { month: 'short', year: 'numeric' }));
                        const data = state.monthlyData.map(d => (d.items[config.type] || []).reduce((sum, item) => sum + item.amount, 0));
                        
                        createOrUpdateChart(config.chartId, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{ label: config.type.charAt(0).toUpperCase() + config.type.slice(1), data: data, borderColor: config.color, backgroundColor: config.color + '33', fill: true, tension: 0.3 }]
                            },
                            options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
                        });
                    });
                };

                const calculateLinearRegression = (data) => {
                    const n = data.length;
                    if (n < 2) return { m: 0, b: data.length > 0 ? data[0].y : 0 };

                    let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
                    data.forEach(p => { sumX += p.x; sumY += p.y; sumXY += p.x * p.y; sumX2 += p.x * p.x; });
                    
                    const m = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
                    const b = (sumY - m * sumX) / n;
                    return { m, b };
                };
                
                const generateForecast = () => {
                    const category = document.getElementById('forecast-category').value;
                    const months = parseInt(document.getElementById('forecast-months').value);
                    
                    const historicalDataPoints = state.monthlyData.map((data, index) => {
                        let value = 0;
                        if (category === 'totalOutflow') {
                            const itemOutflow = ['expenses', 'debts', 'investments', 'bills'].reduce((sum, type) => sum + (data.items[type] || []).reduce((s, i) => s + i.amount, 0), 0);
                            value = itemOutflow + (data.emergency_funds || 0);
                        } else if (category === 'savings') {
                             const itemOutflow = ['expenses', 'debts', 'investments', 'bills'].reduce((sum, type) => sum + (data.items[type] || []).reduce((s, i) => s + i.amount, 0), 0);
                             const totalOutflow = itemOutflow + (data.emergency_funds || 0);
                             value = (data.income || 0) - totalOutflow;
                        } else if (category === 'income') {
                            value = data.income || 0;
                        } else {
                            value = (data.items[category] || []).reduce((sum, item) => sum + item.amount, 0);
                        }
                        return { x: index, y: value };
                    });

                    if (historicalDataPoints.length < 2) {
                        alert("Need at least two months of data to generate a forecast.");
                        return;
                    }

                    const { m, b } = calculateLinearRegression(historicalDataPoints);
                    
                    const forecastDataPoints = [];
                    const lastIndex = historicalDataPoints.length - 1;
                    const lastMonth = new Date(state.monthlyData[lastIndex].month);

                    for (let i = 1; i <= months; i++) {
                        forecastDataPoints.push(m * (lastIndex + i) + b);
                    }

                    const historicalLabels = state.monthlyData.map(d => new Date(d.month).toLocaleString('default', { month: 'short', year: 'numeric' }));
                    const forecastLabels = Array.from({ length: months }, (_, i) => {
                        const futureMonth = new Date(lastMonth);
                        futureMonth.setMonth(lastMonth.getMonth() + i + 1);
                        return futureMonth.toLocaleString('default', { month: 'short', year: 'numeric' });
                    });

                    createOrUpdateChart('forecast-chart', {
                        type: 'line',
                        data: {
                            labels: [...historicalLabels, ...forecastLabels],
                            datasets: [
                                { label: 'Historical Data', data: historicalDataPoints.map(p => p.y), borderColor: '#3b82f6', tension: 0.1 },
                                { label: 'Forecast', data: [...new Array(historicalDataPoints.length).fill(null), ...forecastDataPoints], borderColor: '#16a34a', borderDash: [5, 5], tension: 0.1 }
                            ]
                        }
                    });

                    generateFinancialAnalysis(m);
                };

                const generateFinancialAnalysis = (trendSlope) => {
                    const analysisContainer = document.getElementById('financial-analysis-text');
                    const currentData = state.monthlyData[state.currentMonthIndex];
                    const income = currentData.income || 0;
                    const itemOutflow = ['expenses', 'debts', 'investments', 'bills'].reduce((sum, type) => sum + (currentData.items[type] || []).reduce((s, i) => s + (i.amount || 0), 0), 0);
                    const totalOutflow = itemOutflow + (currentData.emergency_funds || 0);
                    const profit = income - totalOutflow;
                    const savingsRate = income > 0 ? (profit / income * 100).toFixed(1) : 0;
                    const debtToIncome = income > 0 ? ((currentData.items.debts || []).reduce((s, i) => s + i.amount, 0) / income * 100).toFixed(1) : 0;
                    const totalEmergency = state.monthlyData.reduce((sum, month) => sum + (month.emergency_funds || 0), 0);
                    const avgMonthlyOutflow = state.monthlyData.reduce((sum, month) => sum + ['expenses', 'bills'].reduce((s, t) => s + (month.items[t] || []).reduce((is, i) => is + i.amount, 0), 0), 0) / state.monthlyData.length;
                    const emergencyCoverage = avgMonthlyOutflow > 0 ? (totalEmergency / avgMonthlyOutflow).toFixed(1) : 0;

                    let analysisHTML = '<ul>';
                    analysisHTML += `<li class="flex items-start"><span class="mr-2">${savingsRate >= 20 ? '‚úÖ' : (savingsRate > 0 ? '‚ö†Ô∏è' : '‚ùå')}</span><div><strong>Savings Rate: ${savingsRate}%.</strong> A healthy target is 15-20%. ${savingsRate < 15 ? 'Consider reviewing expenses to boost savings.' : 'Excellent work!'}</div></li>`;
                    analysisHTML += `<li class="flex items-start"><span class="mr-2">${debtToIncome <= 36 ? '‚úÖ' : '‚ö†Ô∏è'}</span><div><strong>Debt-to-Income Ratio (monthly payments): ${debtToIncome}%.</strong> Lenders prefer this to be under 36%.</div></li>`;
                    analysisHTML += `<li class="flex items-start"><span class="mr-2">${emergencyCoverage >= 3 ? '‚úÖ' : '‚ö†Ô∏è'}</span><div><strong>Emergency Fund: ${emergencyCoverage} months</strong> of coverage. Aim for 3-6 months for a strong safety net.</div></li>`;
                    const category = document.getElementById('forecast-category').options[document.getElementById('forecast-category').selectedIndex].text;
                    let trendText = 'stable';
                    if (trendSlope > 50) trendText = `<span class="loss">increasing</span>`;
                    if (trendSlope < -50) trendText = `<span class="profit">decreasing</span>`;
                    analysisHTML += `<li class="flex items-start"><span class="mr-2">üìà</span><div>The forecast for your <strong>${category}</strong> shows a relatively <strong>${trendText}</strong> trend. Keep this in mind for future budgeting.</div></li>`;
                    analysisHTML += '</ul>';
                    analysisContainer.innerHTML = analysisHTML;
                };

                listConfigs.forEach(createDynamicListCard);
                lendBorrowConfigs.forEach(createDynamicListCard);
                
                incomeInput.addEventListener('input', (e) => { state.monthlyData[state.currentMonthIndex].income = parseFloat(e.target.value) || 0; updateDashboard(); });
                emergencyFundsInput.addEventListener('input', (e) => { state.monthlyData[state.currentMonthIndex].emergency_funds = parseFloat(e.target.value) || 0; updateDashboard(); });
                monthlyGoalsInput.addEventListener('input', (e) => { state.monthlyData[state.currentMonthIndex].goals = e.target.value; saveData(); }); // NEW
                
                monthSelector.addEventListener('change', (e) => {
                    const selectedMonth = e.target.value + '-01';
                    const monthIndex = state.monthlyData.findIndex(d => d.month === selectedMonth);
                    if (monthIndex !== -1) {
                        state.currentMonthIndex = monthIndex;
                    } else {
                        const newMonthData = { month: selectedMonth, income: 0, emergency_funds: 0, goals: '', items: { expenses: [], debts: [], investments: [], bills: [], lent: [], borrowed: [] } };
                        state.monthlyData.push(newMonthData);
                        state.monthlyData.sort((a,b) => new Date(a.month) - new Date(b.month));
                        state.currentMonthIndex = state.monthlyData.findIndex(d => d.month === selectedMonth);
                    }
                    updateDashboard();
                });

                [...listConfigs, ...lendBorrowConfigs].forEach(({ type }) => {
                    const addBtn = document.getElementById(`add-${type}`);
                    if (addBtn) addBtn.addEventListener('click', () => handleAddItem(type));
                });
                
                document.addEventListener('click', handleRemoveItem);
                downloadBtn.addEventListener('click', handleDownload);
                generateForecastBtn.addEventListener('click', generateForecast);
                
                updateDashboard();
            };
            
            createFloatingSymbols();
            setupLoginScreen();
        });
    </script>
</body>
</html>